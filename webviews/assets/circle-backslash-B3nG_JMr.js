var V=Object.defineProperty;var k=(o,e,t)=>e in o?V(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var m=(o,e,t)=>k(o,typeof e!="symbol"?e+"":e,t);import{R as w,b as Z}from"./CollapseButtonAugment-C3mt1EeR.js";import{W as d}from"./ButtonAugment-DueOA3_V.js";import{S as O,n as D,E as T,T as M}from"./chat-context-Dq8CyOam.js";import{S as b,d as x,e as R,h as f,j as i,k as I,l as v,n as u,m as y,o as F,H as $,u as U,v as z,w as J,p as q,x as W,q as j,r as N}from"./index-p4Dt6o3z.js";function ue(o){try{const e=new Date(o);if(isNaN(e.getTime()))return"Unknown time";const t=new Date().getTime()-e.getTime(),s=Math.floor(t/1e3),n=Math.floor(s/60),r=Math.floor(n/60),a=Math.floor(r/24);return s<60?`${s}s ago`:n<60?`${n}m ago`:r<24?`${r}h ago`:a<30?`${a}d ago`:e.toLocaleDateString()}catch(e){return console.error("Error formatting date:",e),"Unknown time"}}function fe(o){switch(o){case w.agentStarting:return"Starting";case w.agentRunning:return"Running";case w.agentIdle:return"Idle";case w.agentFailed:return"Failed";default:return"Unknown"}}const B=o=>{let e={};for(const t of o){const s=e[t.new_path];e[t.new_path]=s?{...s,new_contents:t.new_contents,new_path:t.new_path}:t}return Object.values(e)},X=o=>{const e=o.flatMap(t=>t.changed_files);return B(e)},_e=(o,e)=>{const t=o.slice(0,e).findLastIndex(n=>n.exchange.request_message),s=o.slice(t+1,e+1).flatMap(n=>n.changed_files);return B(s)},pe=(o,e)=>{var s;const t=o.slice(0,e).findLastIndex(n=>n.exchange.request_message);return((s=o[t])==null?void 0:s.exchange.request_message)??""};class G{constructor(e,t,s){m(this,"_state",{isActive:!1,isPanelFocused:!1,currentAgentId:void 0,currentConversation:void 0,currentAgent:void 0,agentOverviews:[],isLoading:!1,isBackgroundRefreshing:!1,lastSuccessfulOverviewFetch:0,failedRefreshAttempts:0,isDiffPanelOpen:!1,isCreatingAgent:!1,error:void 0,agentThreadsError:void 0,remoteAgentCreationError:null,newAgentDraft:null,notificationSettings:{},setCurrentAgent:this.setCurrentAgent.bind(this),clearCurrentAgent:this.clearCurrentAgent.bind(this),sendMessage:this.sendMessage.bind(this),interruptAgent:this.interruptAgent.bind(this),createRemoteAgent:this.createRemoteAgent.bind(this),createRemoteAgentFromDraft:this.createRemoteAgentFromDraft.bind(this),deleteAgent:this.deleteAgent.bind(this),setNewAgentDraft:this.setNewAgentDraft.bind(this),setRemoteAgentCreationError:this.setRemoteAgentCreationError.bind(this),hasFetchedOnce:!1,showRemoteAgentDiffPanel:this.showRemoteAgentDiffPanel.bind(this),closeRemoteAgentDiffPanel:this.closeRemoteAgentDiffPanel.bind(this),setIsCreatingAgent:this.setIsCreatingAgent.bind(this)});m(this,"_agentConversations",new Map);m(this,"_initialPrompts",new Map);m(this,"_logPollingTimer",null);m(this,"_preloadedDiffExplanations",new Map);m(this,"maxCacheEntries",10);m(this,"maxCacheSizeBytes",10485760);m(this,"_diffOpsModel");m(this,"subscribers",new Set);m(this,"_historyPollingTimer",null);m(this,"_overviewsPollingTimer",null);m(this,"agentSetupLogs");m(this,"dispose",()=>{this.stopPolling(),this.subscribers.clear()});this._asyncMsgSender=e,this._flagsModel=s,this._state.isActive=t,this._diffOpsModel=new Z(e),this._flagsModel.subscribe(n=>{const r=this._historyPollingTimer||this._overviewsPollingTimer,a=n.enableBackgroundAgents;a&&!r?this.startPolling():!a&&r&&this.stopPolling()}),this._flagsModel.enableBackgroundAgents&&this.startPolling()}subscribe(e){return this.subscribers.add(e),e(this),()=>{this.subscribers.delete(e)}}notifySubscribers(){this.subscribers.forEach(e=>e(this))}showRemoteAgentDiffPanel(e){const t=this._state.currentAgentId;if(t&&e.changedFiles.length>0){const s=`${t}-${this.generateChangedFilesHash(e.changedFiles)}`,n=this._preloadedDiffExplanations.get(s);if(n)return n.lastAccessed=Date.now(),this._preloadedDiffExplanations.set(s,n),void this._asyncMsgSender.send({type:d.showRemoteAgentDiffPanel,data:{...e,preloadedExplanation:n.explanation}})}this._asyncMsgSender.send({type:d.showRemoteAgentDiffPanel,data:e}),this._state.isDiffPanelOpen=!0}closeRemoteAgentDiffPanel(){this._asyncMsgSender.send({type:d.closeRemoteAgentDiffPanel}),this._state.isDiffPanelOpen=!1}getCurrentChatHistory(){var s;const e=((s=this.currentConversation)==null?void 0:s.exchanges)??[],t=this.isCurrentAgentRunning;if(e.length===0&&this.currentAgentId){this.currentAgentId&&this._startLogPolling(this.currentAgentId);const n=this.getInitialPrompt(this.currentAgentId);if(n)return[{seen_state:O.seen,structured_request_nodes:[{id:0,type:D.TEXT,text_node:{content:n}}],status:T.sent,request_message:n,response_text:"Waiting for agent to start...",structured_output_nodes:[],request_id:"remote-agent-initial"}]}return e.map(({exchange:n},r)=>({seen_state:O.seen,structured_request_nodes:n.request_nodes??[],status:r===e.length-1&&t?T.sent:T.success,request_message:n.request_message,response_text:n.response_text,structured_output_nodes:n.response_nodes??[],request_id:n.request_id??`remote-agent-${r}`}))}getToolStates(){var h,c,l;const e=new Map,t=new Set,s=new Map;(h=this.currentConversation)==null||h.exchanges.forEach(g=>{var p,E;(p=g.exchange.response_nodes)==null||p.forEach(_=>{_.tool_use&&t.add(_.tool_use.tool_use_id)}),(E=g.exchange.request_nodes)==null||E.forEach(_=>{_.type===D.TOOL_RESULT&&_.tool_result_node&&s.set(_.tool_result_node.tool_use_id,_.tool_result_node)})});const n=(c=this.currentConversation)==null?void 0:c.exchanges[this.currentConversation.exchanges.length-1];let r=0,a=null;return(l=n==null?void 0:n.exchange.response_nodes)==null||l.forEach(g=>{var p;g.id>r&&(r=g.id,a=(p=g.tool_use)!=null&&p.tool_use_id?g.tool_use.tool_use_id:null)}),t.forEach(g=>{const p=s.get(g);if(p)e.set(g,{phase:p.is_error?M.error:M.completed,result:{isError:p.is_error,text:p.content},requestId:"",toolUseId:g});else{const E=this.isCurrentAgentRunning;g===a?e.set(g,{phase:E?M.running:M.cancelled,requestId:"",toolUseId:g}):e.set(g,{phase:M.cancelled,requestId:"",toolUseId:g})}}),e}getToolUseState(e){const t=e;return this.getToolStates().get(t)??{phase:M.completed,requestId:"",toolUseId:e}}async setCurrentAgent(e){this._stopLogPolling(),this._state.currentAgentId=e,this.agentSetupLogs=void 0,this.notifySubscribers(),e&&(await Promise.allSettled([this.refreshAgentOverviews(),this.fetchAgentConversation(e)]),this.preloadDiffExplanation(e))}clearCurrentAgent(){this._state.currentAgentId=void 0,this.agentSetupLogs=void 0,this.notifySubscribers()}async preloadDiffExplanation(e){const t=this._agentConversations.get(e);if(!t||t.exchanges.length===0)return;const s=X(t.exchanges);if(s.length===0)return;const n=`${e}-${this.generateChangedFilesHash(s)}`;if(this._preloadedDiffExplanations.get(n)||s.length>12)return;let r=0;if(s.forEach(a=>{var h,c;r+=(((h=a.old_contents)==null?void 0:h.length)||0)+(((c=a.new_contents)==null?void 0:c.length)||0)}),!(r>512e3))try{const a=await this._diffOpsModel.getDiffExplanation(s,void 0,6e4);if(a&&a.length>0){const h=this.generateChangedFilesHash(s),c=`${e}-${h}`;this._preloadedDiffExplanations.set(c,{explanation:a,changedFiles:s,userPrompt:this.getUserMessagePrecedingTurn(t.exchanges,0),timestamp:Date.now(),lastAccessed:Date.now(),changedFilesHash:h}),this.manageCacheSize()}}catch(a){console.error("Failed to preload diff explanation:",a)}}getUserMessagePrecedingTurn(e,t){return e.length===0||t<0||t>=e.length?"":e[t].exchange.request_message||""}generateChangedFilesHash(e){const t=e.map(s=>{var n,r;return{oldPath:s.old_path,newPath:s.new_path,oldSize:((n=s.old_contents)==null?void 0:n.length)||0,newSize:((r=s.new_contents)==null?void 0:r.length)||0,oldHash:this.simpleHash(s.old_contents||""),newHash:this.simpleHash(s.new_contents||"")}});return this.simpleHash(JSON.stringify(t))}simpleHash(e){let t=0;for(let s=0;s<e.length;s++)t=(t<<5)-t+e.charCodeAt(s),t|=0;return t.toString(36)}manageCacheSize(){if(this._preloadedDiffExplanations.size<=this.maxCacheEntries)return;const e=Array.from(this._preloadedDiffExplanations.entries()).map(([s,n])=>({key:s,value:n,accessTime:n.lastAccessed||n.timestamp})).sort((s,n)=>s.accessTime-n.accessTime);let t=0;for(e.forEach(s=>{const n=JSON.stringify(s.value.explanation).length,r=s.value.changedFiles.reduce((a,h)=>{var c,l;return a+(((c=h.old_contents)==null?void 0:c.length)||0)+(((l=h.new_contents)==null?void 0:l.length)||0)},0);t+=n+r});e.length>0&&(e.length>this.maxCacheEntries||t>this.maxCacheSizeBytes);){const s=e.shift();if(s){this._preloadedDiffExplanations.delete(s.key);const n=JSON.stringify(s.value.explanation).length,r=s.value.changedFiles.reduce((a,h)=>{var c,l;return a+(((c=h.old_contents)==null?void 0:c.length)||0)+(((l=h.new_contents)==null?void 0:l.length)||0)},0);t-=n+r}}}async fetchAgentConversation(e){var t,s,n;if(e&&((t=this.currentAgent)==null?void 0:t.status)!==w.agentStarting){this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{const r=this.getfinalSequenceId(e)??0,a=r===0?0:r-1,h=await this._asyncMsgSender.send({type:d.getRemoteAgentChatHistoryRequest,data:{agentId:e,lastProcessedSequenceId:a}},1e4);if(h.data.error)throw new Error(h.data.error);const c=h.data.chatHistory.filter(_=>_.exchange!==null),l=((s=this._agentConversations.get(e))==null?void 0:s.exchanges)||[],g=c.length>l.length,p=(n=this._agentConversations.get(e))==null?void 0:n.exchanges,E=p?function(_,C){if(_.length===0)return C;if(C.length===0)return _;const L=[];let A=0,S=0;for(;A<_.length&&S<C.length;){const P=_[A].sequence_id,H=C[S].sequence_id;H!==void 0?P!==void 0?P<H?(L.push(_[A]),A++):P>H?(L.push(C[S]),S++):(L.push(C[S]),A++,S++):(console.warn("Existing history has an exchange with an undefined sequence ID"),A++):(console.warn("New history has an exchange with an undefined sequence ID"),S++)}for(;A<_.length;)L.push(_[A]),A++;for(;S<C.length;)L.push(C[S]),S++;return L}(p,c):c;this._agentConversations.set(e,{exchanges:E,lastFetched:new Date}),this._state.currentConversation=this._agentConversations.get(e),c.length>0&&(this.clearInitialPrompt(e),g&&this.preloadDiffExplanation(e))}catch(r){this._state.error=r instanceof Error?r.message:String(r)}finally{this._state.isLoading=!1,this.notifySubscribers()}}}async sendMessage(e){const t=this._state.currentAgentId;if(!t)return this._state.error="No active remote agent",this.notifySubscribers(),!1;this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{await this._asyncMsgSender.send({type:d.remoteAgentChatRequest,data:{agentId:t,requestDetails:{request_nodes:[{id:0,type:D.TEXT,text_node:{content:e}}]}}},1e4),Promise.allSettled([this.fetchAgentConversation(t),this.refreshAgentOverviews()])}catch(s){return this._state.error=s instanceof Error?s.message:String(s),this.notifySubscribers(),!1}finally{this._state.isLoading=!1,this.preloadDiffExplanation(t),this.notifySubscribers()}return!0}async interruptAgent(){const e=this._state.currentAgentId;if(!e)return this._state.error="No active remote agent",void this.notifySubscribers();this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{await this._asyncMsgSender.send({type:d.remoteAgentInterruptRequest,data:{agentId:e}},1e4);const t=this._agentConversations.get(e);t&&this._agentConversations.set(e,t)}catch(t){this._state.error=t instanceof Error?t.message:String(t)}finally{this._state.isLoading=!1,this.notifySubscribers()}}async createRemoteAgent(e,t,s){var n;if(!e||!e.trim())return this._state.error="Cannot create a remote agent with an empty prompt",void this.notifySubscribers();this.agentSetupLogs=void 0,this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{const r=await this._asyncMsgSender.send({type:d.createRemoteAgentRequest,data:{prompt:e,workspaceSetup:t,setupScript:s}},1e4);return r.data.agentId?(this._initialPrompts.set(r.data.agentId,e),await this.setNotificationEnabled(r.data.agentId,((n=this.newAgentDraft)==null?void 0:n.enableNotification)??!1),await this.setCurrentAgent(r.data.agentId),r.data.agentId):(this._state.error="Failed to create remote agent",void this.notifySubscribers())}catch(r){return this._state.error=r instanceof Error?r.message:String(r),void this.notifySubscribers()}finally{this._state.isLoading=!1,this.notifySubscribers()}}async createRemoteAgentFromDraft(e){var n;if(this.setRemoteAgentCreationError(null),this.agentSetupLogs=void 0,!e||!e.trim())return void this.setRemoteAgentCreationError("Cannot create a remote agent with an empty prompt");const t=this._state.newAgentDraft;if(!t)return void this.setRemoteAgentCreationError("No workspace selected. Please select a workspace first.");if(t.isDisabled)return void this.setRemoteAgentCreationError("Cannot create agent with current workspace selection. Please resolve the issues with your workspace selection.");const s={starting_files:t.commitRef};this._state.isLoading=!0,this.notifySubscribers();try{let r=(n=t.setupScript)==null?void 0:n.content;if(t.setupScript){const h=(await this.listSetupScripts()).find(c=>c.path===t.setupScript.path);h&&(r=h.content)}const a=await this.createRemoteAgent(e,s,r);return a||this.setRemoteAgentCreationError("Failed to create remote agent. Please try again."),a}catch{this.setRemoteAgentCreationError("Failed to create remote agent. Please try again.")}finally{this._state.isLoading=!1,this.notifySubscribers()}}async deleteAgent(e){this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{if(!(await this._asyncMsgSender.send({type:d.deleteRemoteAgentRequest,data:{agentId:e}},1e4)).data.success)return this._state.error="Failed to delete remote agent",void this.notifySubscribers();this._agentConversations.delete(e),this._state.agentOverviews=this._state.agentOverviews.filter(t=>t.remote_agent_id!==e),this.removeNotificationEnabled(e),this._state.currentAgentId===e&&this.clearCurrentAgent()}catch(t){this._state.error=t instanceof Error?t.message:String(t)}finally{this._state.isLoading=!1,this.notifySubscribers()}}async sshToRemoteAgent(e){this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{const t=await this._asyncMsgSender.send({type:d.remoteAgentSshRequest,data:{agentId:e.remote_agent_id}},1e4);return!!t.data.success||(console.error("Failed to connect to remote agent:",t.data.error),this.notifySubscribers(),!1)}catch(t){return this._state.error=t instanceof Error?t.message:String(t),this.notifySubscribers(),!1}finally{this._state.isLoading=!1,this.notifySubscribers()}}async refreshCurrentAgent(){const e=this._state.currentAgentId;e&&await this.fetchAgentConversation(e)}async refreshAgentOverviews(){const e=!this._state.hasFetchedOnce;e?this._state.isLoading=!0:this._state.isBackgroundRefreshing=!0,(e||this._state.failedRefreshAttempts===0)&&(this._state.agentThreadsError=void 0),this.notifySubscribers();const t=Math.min(1e3*Math.pow(2,this._state.failedRefreshAttempts),1e4);try{const s=await this._asyncMsgSender.send({type:d.getRemoteAgentOverviewsRequest},1e4);if(s.data.error)throw new Error(s.data.error);this._state.failedRefreshAttempts=0,this._state.lastSuccessfulOverviewFetch=Date.now();const n=this._state.agentOverviews,r=s.data.overviews,a=new Map(n.map(l=>[l.remote_agent_id,l])),h=await this.getRemoteAgentNotificationEnabled(r.map(l=>l.remote_agent_id));r.forEach(l=>{const g=a.get(l.remote_agent_id),p=h[l.remote_agent_id],E=(g==null?void 0:g.status)===w.agentRunning,_=l.status===w.agentIdle||l.status===w.agentFailed,C=l.remote_agent_id!==this._state.currentAgentId,L=this._state.isPanelFocused;p&&E&&_&&(C||!L)&&this.notifyRemoteAgentReady(l.remote_agent_id)});const c=r.sort((l,g)=>{const p=new Date(l.updated_at||l.started_at);return new Date(g.updated_at||g.started_at).getTime()-p.getTime()});if(this._state.currentAgentId){const l=c.findIndex(g=>g.remote_agent_id===this._state.currentAgentId);if(l>0){const g=c.splice(l,1)[0];c.unshift(g)}}return this._state.agentOverviews=c,this.notifySubscribers(),c}catch(s){return this._state.failedRefreshAttempts++,console.error("Failed to get remote agent overviews:",s),e||this._state.agentOverviews.length===0?this._state.agentThreadsError=s instanceof Error?s.message:String(s):(console.warn("Background refresh failed:",s),Date.now()-this._state.lastSuccessfulOverviewFetch>3e4&&!this._state.agentThreadsError&&this._state.failedRefreshAttempts>1&&(this._state.agentThreadsError="Using cached data. Refresh failed: "+(s instanceof Error?s.message:String(s)))),this._state.failedRefreshAttempts<=3&&setTimeout(()=>{this._state.isActive&&this.refreshAgentOverviews()},t),this.notifySubscribers(),this._state.agentOverviews}finally{this._state.isLoading=!1,this._state.isBackgroundRefreshing=!1,this._state.hasFetchedOnce=!0,this.notifySubscribers()}}async getRemoteAgentNotificationEnabled(e){return(await this._asyncMsgSender.send({type:d.getRemoteAgentNotificationEnabledRequest,data:{agentIds:e}})).data}async setRemoteAgentNotificationEnabled(e,t){await this._asyncMsgSender.send({type:d.setRemoteAgentNotificationEnabled,data:{agentId:e,enabled:t}})}async deleteRemoteAgentNotificationEnabled(e){await this._asyncMsgSender.send({type:d.deleteRemoteAgentNotificationEnabled,data:{agentId:e}})}refreshAgentNotificationSettings(){this._state.isLoading=!0,this.notifySubscribers();try{this.getRemoteAgentNotificationEnabled().then(e=>{this._state.notificationSettings=e,this.notifySubscribers()})}catch(e){console.error("Failed to get remote agent notification settings:",e)}}async setNotificationEnabled(e,t){await this.setRemoteAgentNotificationEnabled(e,t),this._state={...this._state,notificationSettings:{...this._state.notificationSettings,[e]:t}},this.notifySubscribers()}async removeNotificationEnabled(e){await this.deleteRemoteAgentNotificationEnabled(e);const{[e]:t,...s}=this._state.notificationSettings;this._state={...this._state,notificationSettings:s},this.notifySubscribers()}async notifyRemoteAgentReady(e){await this._asyncMsgSender.send({type:d.remoteAgentNotifyReady,data:{agentId:e}})}get hasFetchedOnce(){return this._state.hasFetchedOnce}handleMessageFromExtension(e){const t=e.data.type===d.asyncWrapper?e.data.baseMsg.type:e.data.type;if(!e||!t)return!1;switch(t){case d.remoteAgentChatResponse:return this._state.currentAgentId&&setTimeout(()=>{this.preloadDiffExplanation(this._state.currentAgentId)},0),!0;case d.getRemoteAgentChatHistoryResponse:case d.remoteAgentInterruptResponse:case d.createRemoteAgentResponse:case d.getRemoteAgentOverviewsResponse:return!0;case d.showRemoteAgentDiffPanel:return this._state.isDiffPanelOpen=!0,!0;case d.closeRemoteAgentDiffPanel:return this._state.isDiffPanelOpen=!1,!0;default:return!1}}get currentAgentId(){return this._state.currentAgentId}get currentConversation(){return this._agentConversations.get(this._state.currentAgentId??"")??void 0}get currentExchanges(){var t;const e=this._state.currentAgentId;return e&&((t=this._agentConversations.get(e))==null?void 0:t.exchanges)||[]}get currentStatus(){var t;const e=this._state.currentAgentId;return e&&((t=this._state.agentOverviews.find(s=>s.remote_agent_id===e))==null?void 0:t.status)||w.agentIdle}get currentAgent(){const e=this._state.currentAgentId;return e?this._state.agentOverviews.find(t=>t.remote_agent_id===e):void 0}get agentOverviews(){return this._state.agentOverviews}get isLoading(){return this._state.isLoading}get isBackgroundRefreshing(){return this._state.isBackgroundRefreshing}get lastSuccessfulOverviewFetch(){return this._state.lastSuccessfulOverviewFetch}get error(){return this._state.error}get agentThreadsError(){return this._state.agentThreadsError}get isCurrentAgentRunning(){return this.currentStatus===w.agentRunning||this.currentStatus===w.agentStarting}getInitialPrompt(e){return this._initialPrompts.get(e)}clearInitialPrompt(e){this._initialPrompts.delete(e)}get notificationSettings(){return this._state.notificationSettings}getfinalSequenceId(e){var n;const t=this._agentConversations.get(e),s=t==null?void 0:t.exchanges;if(s)return((n=s[s.length-1])==null?void 0:n.sequence_id)??void 0}async listSetupScripts(){try{return(await this._asyncMsgSender.send({type:d.listSetupScriptsRequest},5e3)).data.scripts}catch(e){return this._state.error=e instanceof Error?e.message:String(e),this.notifySubscribers(),[]}}async saveSetupScript(e,t,s){try{const n=await this._asyncMsgSender.send({type:d.saveSetupScriptRequest,data:{name:e,content:t,location:s}},5e3);return n.data.success||(this._state.error=n.data.error||"Failed to save setup script",this.notifySubscribers()),n.data}catch(n){return this._state.error=n instanceof Error?n.message:String(n),this.notifySubscribers(),{success:!1,error:n instanceof Error?n.message:String(n)}}}async deleteSetupScript(e,t){try{const s=await this._asyncMsgSender.send({type:d.deleteSetupScriptRequest,data:{name:e,location:t}},5e3);return s.data.success||(this._state.error=s.data.error||"Failed to delete setup script",this.notifySubscribers()),s.data}catch(s){return this._state.error=s instanceof Error?s.message:String(s),this.notifySubscribers(),{success:!1,error:s instanceof Error?s.message:String(s)}}}async renameSetupScript(e,t,s){try{const n=await this._asyncMsgSender.send({type:d.renameSetupScriptRequest,data:{oldName:e,newName:t,location:s}},5e3);return n.data.success||(this._state.error=n.data.error||"Failed to rename setup script",this.notifySubscribers()),n.data}catch(n){return this._state.error=n instanceof Error?n.message:String(n),this.notifySubscribers(),{success:!1,error:n instanceof Error?n.message:String(n)}}}startPolling(){this._flagsModel.enableBackgroundAgents&&(this.stopPolling(),this.refreshCurrentAgent(),this.refreshAgentOverviews(),this.refreshAgentNotificationSettings(),this._historyPollingTimer=setInterval(()=>{this._state.isActive&&this.refreshCurrentAgent()},1e3),this._overviewsPollingTimer=setInterval(()=>{this._state.isActive&&this.refreshAgentOverviews()},5e3))}stopPolling(){this._historyPollingTimer&&(clearInterval(this._historyPollingTimer),this._historyPollingTimer=null),this._overviewsPollingTimer&&(clearInterval(this._overviewsPollingTimer),this._overviewsPollingTimer=null)}get isActive(){return this._state.isActive}setIsActive(e){this._state.isActive=e,this.notifySubscribers()}get isPanelFocused(){return this._state.isPanelFocused}setIsPanelFocused(e){this._state.isPanelFocused=e,this.notifySubscribers()}setRemoteAgentCreationError(e){this._state.remoteAgentCreationError=e,this.notifySubscribers()}get isDiffPanelOpen(){return this._state.isDiffPanelOpen}get remoteAgentCreationError(){return this._state.remoteAgentCreationError}setNewAgentDraft(e){this._state.newAgentDraft=e,this.notifySubscribers()}get newAgentDraft(){return this._state.newAgentDraft}async getAgentLogs(e){this._state.isLoading=!0,this._state.error=void 0,this.notifySubscribers();try{const t=await this._asyncMsgSender.send({type:d.remoteAgentWorkspaceLogsRequest,data:{agentId:e}},1e4);return t.data.workspaceSetupStatus?t.data.workspaceSetupStatus:void 0}catch(t){const s=t instanceof Error?t.message:String(t);return this._state.error=s,void this.notifySubscribers()}finally{this._state.isLoading=!1,this.notifySubscribers()}}setIsCreatingAgent(e){this._state.isCreatingAgent=e,this.notifySubscribers()}get isCreatingAgent(){return this._state.isCreatingAgent}_startLogPolling(e){this._logPollingTimer||(this._fetchAgentLogs(e),this._logPollingTimer=setInterval(()=>{this._fetchAgentLogs(e)},500))}_stopLogPolling(){this._logPollingTimer&&(clearInterval(this._logPollingTimer),this._logPollingTimer=null)}async _fetchAgentLogs(e){var s;try{const n=await this.getAgentLogs(e);JSON.stringify(n)!==JSON.stringify(this.agentSetupLogs)&&(this.agentSetupLogs={steps:(t=n,(s=t==null?void 0:t.steps)!=null&&s.length?t.steps.reduce((a,h)=>{const c=a[a.length-1];return c&&c.step_number===h.step_number?(c.logs+=`
${h.logs}`,c.status=h.status):a.push(h),a},[]):[])},this.notifySubscribers());const r=this._state.agentOverviews.find(a=>a.remote_agent_id===e);if(r&&r.status!==w.agentStarting)return void this._stopLogPolling()}catch(n){console.error("Error fetching agent logs:",n)}var t}}m(G,"key","remoteAgentsModel");function K(o){let e,t,s,n,r;return{c(){e=f("svg"),t=f("rect"),s=f("path"),n=f("path"),r=f("path"),i(t,"width","16"),i(t,"height","16"),i(t,"fill","currentColor"),i(t,"fill-opacity","0.01"),i(s,"fill-rule","evenodd"),i(s,"clip-rule","evenodd"),i(s,"d","M3.4718 3.46066C3.65925 3.2732 3.96317 3.2732 4.15062 3.46066L7.35062 6.66066C7.44064 6.75068 7.49121 6.87277 7.49121 7.00007C7.49121 7.12737 7.44064 7.24946 7.35062 7.33949L4.15062 10.5395C3.96317 10.7269 3.65925 10.7269 3.4718 10.5395C3.28435 10.352 3.28435 10.0481 3.4718 9.86067L6.33239 7.00007L3.4718 4.13949C3.28435 3.95203 3.28435 3.64812 3.4718 3.46066Z"),i(s,"fill","currentColor"),i(n,"fill-rule","evenodd"),i(n,"clip-rule","evenodd"),i(n,"d","M7.86854 10.6132C7.57399 10.6132 7.33521 10.8519 7.33521 11.1465C7.33521 11.441 7.57399 11.6798 7.86854 11.6798H12.1352C12.4298 11.6798 12.6685 11.441 12.6685 11.1465C12.6685 10.8519 12.4298 10.6132 12.1352 10.6132H7.86854Z"),i(n,"fill","currentColor"),i(r,"fill-rule","evenodd"),i(r,"clip-rule","evenodd"),i(r,"d","M2.13331 1.06665C1.5442 1.06665 1.06664 1.54421 1.06664 2.13332V13.8667C1.06664 14.4558 1.5442 14.9333 2.13331 14.9333H13.8667C14.4558 14.9333 14.9333 14.4558 14.9333 13.8667V2.13332C14.9333 1.54421 14.4558 1.06665 13.8667 1.06665H2.13331ZM2.13331 2.13332H13.8667V13.8667H2.13331V2.13332Z"),i(r,"fill","currentColor"),i(e,"width","16"),i(e,"height","16"),i(e,"viewBox","0 0 16 16"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(a,h){I(a,e,h),v(e,t),v(e,s),v(e,n),v(e,r)},p:u,i:u,o:u,d(a){a&&y(e)}}}class me extends b{constructor(e){super(),x(this,e,null,K,R,{})}}const we="messageRenderOptions",ve={doHideThreadSelector:!1,doHideStatusBars:!1,doHideSlashActions:!1,doHideAtMentions:!1,doHideAgentSwitcher:!1,doHideNewThreadButton:!1,doHideMultimodalActions:!1,doHideContextBar:!1,doShowTurnSelector:!1,doHideFloatingButtons:!1},Ce={doHideThreadSelector:!0,doHideStatusBars:!0,doHideSlashActions:!0,doHideAtMentions:!0,doHideAgentSwitcher:!1,doHideNewThreadButton:!0,doHideMultimodalActions:!0,doHideContextBar:!0,doShowTurnSelector:!0,doHideFloatingButtons:!0},Se="selectedTurnIndex";function Q(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M12 13C12.5523 13 13 12.5523 13 12V3C13 2.44771 12.5523 2 12 2H3C2.44771 2 2 2.44771 2 3V6.5C2 6.77614 2.22386 7 2.5 7C2.77614 7 3 6.77614 3 6.5V3H12V12H8.5C8.22386 12 8 12.2239 8 12.5C8 12.7761 8.22386 13 8.5 13H12ZM9 6.5C9 6.5001 9 6.50021 9 6.50031V6.50035V9.5C9 9.77614 8.77614 10 8.5 10C8.22386 10 8 9.77614 8 9.5V7.70711L2.85355 12.8536C2.65829 13.0488 2.34171 13.0488 2.14645 12.8536C1.95118 12.6583 1.95118 12.3417 2.14645 12.1464L7.29289 7H5.5C5.22386 7 5 6.77614 5 6.5C5 6.22386 5.22386 6 5.5 6H8.5C8.56779 6 8.63244 6.01349 8.69139 6.03794C8.74949 6.06198 8.80398 6.09744 8.85143 6.14433C8.94251 6.23434 8.9992 6.35909 8.99999 6.49708L8.99999 6.49738"),i(t,"fill","currentColor"),i(e,"class",o[0]),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p(s,[n]){1&n&&i(e,"class",s[0])},i:u,o:u,d(s){s&&y(e)}}}function Y(o,e,t){let{class:s=""}=e;return o.$$set=n=>{"class"in n&&t(0,s=n.class)},[s]}class ye extends b{constructor(e){super(),x(this,e,Y,Q,R,{class:0})}}function ee(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M3.5 2.82672C3.5 2.55058 3.72386 2.32672 4 2.32672H9.79289L12.5 5.03383V12.8267C12.5 13.1028 12.2761 13.3267 12 13.3267H4C3.72386 13.3267 3.5 13.1028 3.5 12.8267V2.82672ZM4 1.32672C3.17157 1.32672 2.5 1.99829 2.5 2.82672V12.8267C2.5 13.6551 3.17157 14.3267 4 14.3267H12C12.8284 14.3267 13.5 13.6551 13.5 12.8267V4.93027C13.5 4.73136 13.421 4.5406 13.2803 4.39994L10.3535 1.47317C10.2598 1.3794 10.1326 1.32672 10 1.32672H4ZM10.25 6.6595C10.5261 6.6595 10.75 6.43564 10.75 6.1595C10.75 5.88336 10.5261 5.6595 10.25 5.6595H8.49996L8.49996 3.9095C8.49996 3.6334 8.2761 3.4095 7.99996 3.4095C7.72382 3.4095 7.49996 3.6334 7.49996 3.9095V5.6595H5.74996C5.47386 5.6595 5.24996 5.88336 5.24996 6.1595C5.24996 6.43564 5.47386 6.6595 5.74996 6.6595L7.49996 6.6595V8.4095C7.49996 8.68564 7.72382 8.9095 7.99996 8.9095C8.2761 8.9095 8.49996 8.68564 8.49996 8.4095V6.6595H10.25ZM10.4999 11.4188C10.4999 11.695 10.2761 11.9188 9.99993 11.9188H5.99993C5.72379 11.9188 5.49993 11.695 5.49993 11.4188C5.49993 11.1427 5.72379 10.9188 5.99993 10.9188H9.99993C10.2761 10.9188 10.4999 11.1427 10.4999 11.4188Z"),i(t,"fill","currentColor"),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p:u,i:u,o:u,d(s){s&&y(e)}}}class Ae extends b{constructor(e){super(),x(this,e,null,ee,R,{})}}function te(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M11.4669 3.72684C11.7558 3.91574 11.8369 4.30308 11.648 4.59198L7.39799 11.092C7.29783 11.2452 7.13556 11.3467 6.95402 11.3699C6.77247 11.3931 6.58989 11.3355 6.45446 11.2124L3.70446 8.71241C3.44905 8.48022 3.43023 8.08494 3.66242 7.82953C3.89461 7.57412 4.28989 7.55529 4.5453 7.78749L6.75292 9.79441L10.6018 3.90792C10.7907 3.61902 11.178 3.53795 11.4669 3.72684Z"),i(t,"fill","currentColor"),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p:u,i:u,o:u,d(s){s&&y(e)}}}class be extends b{constructor(e){super(),x(this,e,null,te,R,{})}}function se(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M3.5 2C3.22386 2 3 2.22386 3 2.5V12.5C3 12.7761 3.22386 13 3.5 13H11.5C11.7761 13 12 12.7761 12 12.5V4.70711L9.29289 2H3.5ZM2 2.5C2 1.67157 2.67157 1 3.5 1H9.5C9.63261 1 9.75979 1.05268 9.85355 1.14645L12.7803 4.07322C12.921 4.21388 13 4.40464 13 4.60355V12.5C13 13.3284 12.3284 14 11.5 14H3.5C2.67157 14 2 13.3284 2 12.5V2.5ZM4.75 7.5C4.75 7.22386 4.97386 7 5.25 7H7V5.25C7 4.97386 7.22386 4.75 7.5 4.75C7.77614 4.75 8 4.97386 8 5.25V7H9.75C10.0261 7 10.25 7.22386 10.25 7.5C10.25 7.77614 10.0261 8 9.75 8H8V9.75C8 10.0261 7.77614 10.25 7.5 10.25C7.22386 10.25 7 10.0261 7 9.75V8H5.25C4.97386 8 4.75 7.77614 4.75 7.5Z"),i(t,"fill","currentColor"),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p:u,i:u,o:u,d(s){s&&y(e)}}}class xe extends b{constructor(e){super(),x(this,e,null,se,R,{})}}function ne(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M3.13523 8.84197C3.3241 9.04343 3.64052 9.05363 3.84197 8.86477L7.5 5.43536L11.158 8.86477C11.3595 9.05363 11.6759 9.04343 11.8648 8.84197C12.0536 8.64051 12.0434 8.32409 11.842 8.13523L7.84197 4.38523C7.64964 4.20492 7.35036 4.20492 7.15803 4.38523L3.15803 8.13523C2.95657 8.32409 2.94637 8.64051 3.13523 8.84197Z"),i(t,"fill","currentColor"),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p:u,i:u,o:u,d(s){s&&y(e)}}}class Re extends b{constructor(e){super(),x(this,e,null,ne,R,{})}}function ie(o){let e,t,s=[{xmlns:"http://www.w3.org/2000/svg"},{"data-ds-icon":"fa"},{viewBox:"0 0 448 512"},o[0]],n={};for(let r=0;r<s.length;r+=1)n=F(n,s[r]);return{c(){e=f("svg"),t=new $(!0),this.h()},l(r){e=U(r,"svg",{xmlns:!0,"data-ds-icon":!0,viewBox:!0});var a=z(e);t=J(a,!0),a.forEach(y),this.h()},h(){t.a=null,q(e,n)},m(r,a){W(r,e,a),t.m('<!--! Font Awesome Pro 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2024 Fonticons, Inc.--><path d="M448 128c0 53-43 96-96 96-28.9 0-54.8-12.8-72.4-33l-89.7 44.9c1.4 6.5 2.1 13.2 2.1 20.1s-.7 13.6-2.1 20.1l89.7 44.9c17.6-20.2 43.5-33 72.4-33 53 0 96 43 96 96s-43 96-96 96-96-43-96-96c0-6.9.7-13.6 2.1-20.1L168.4 319c-17.6 20.2-43.5 33-72.4 33-53 0-96-43-96-96s43-96 96-96c28.9 0 54.8 12.8 72.4 33l89.7-44.9c-1.4-6.5-2.1-13.2-2.1-20.1 0-53 43-96 96-96s96 43 96 96M96 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96m304-176a48 48 0 1 0-96 0 48 48 0 1 0 96 0m-48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96"/>',e)},p(r,[a]){q(e,n=j(s,[{xmlns:"http://www.w3.org/2000/svg"},{"data-ds-icon":"fa"},{viewBox:"0 0 448 512"},1&a&&r[0]]))},i:u,o:u,d(r){r&&y(e)}}}function re(o,e,t){return o.$$set=s=>{t(0,e=F(F({},e),N(s)))},[e=N(e)]}class Ee extends b{constructor(e){super(),x(this,e,re,ie,R,{})}}function ae(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M1.90321 7.29677C1.90321 10.341 4.11041 12.4147 6.58893 12.8439C6.87255 12.893 7.06266 13.1627 7.01355 13.4464C6.96444 13.73 6.69471 13.9201 6.41109 13.871C3.49942 13.3668 0.86084 10.9127 0.86084 7.29677C0.860839 5.76009 1.55996 4.55245 2.37639 3.63377C2.96124 2.97568 3.63034 2.44135 4.16846 2.03202L2.53205 2.03202C2.25591 2.03202 2.03205 1.80816 2.03205 1.53202C2.03205 1.25588 2.25591 1.03202 2.53205 1.03202L5.53205 1.03202C5.80819 1.03202 6.03205 1.25588 6.03205 1.53202L6.03205 4.53202C6.03205 4.80816 5.80819 5.03202 5.53205 5.03202C5.25591 5.03202 5.03205 4.80816 5.03205 4.53202L5.03205 2.68645L5.03054 2.68759L5.03045 2.68766L5.03044 2.68767L5.03043 2.68767C4.45896 3.11868 3.76059 3.64538 3.15554 4.3262C2.44102 5.13021 1.90321 6.10154 1.90321 7.29677ZM13.0109 7.70321C13.0109 4.69115 10.8505 2.6296 8.40384 2.17029C8.12093 2.11718 7.93465 1.84479 7.98776 1.56188C8.04087 1.27898 8.31326 1.0927 8.59616 1.14581C11.4704 1.68541 14.0532 4.12605 14.0532 7.70321C14.0532 9.23988 13.3541 10.4475 12.5377 11.3662C11.9528 12.0243 11.2837 12.5586 10.7456 12.968L12.3821 12.968C12.6582 12.968 12.8821 13.1918 12.8821 13.468C12.8821 13.7441 12.6582 13.968 12.3821 13.968L9.38205 13.968C9.10591 13.968 8.88205 13.7441 8.88205 13.468L8.88205 10.468C8.88205 10.1918 9.10591 9.96796 9.38205 9.96796C9.65819 9.96796 9.88205 10.1918 9.88205 10.468L9.88205 12.3135L9.88362 12.3123C10.4551 11.8813 11.1535 11.3546 11.7585 10.6738C12.4731 9.86976 13.0109 8.89844 13.0109 7.70321Z"),i(t,"fill","currentColor"),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p:u,i:u,o:u,d(s){s&&y(e)}}}class Le extends b{constructor(e){super(),x(this,e,null,ae,R,{})}}function oe(o){let e,t;return{c(){e=f("svg"),t=f("path"),i(t,"fill-rule","evenodd"),i(t,"clip-rule","evenodd"),i(t,"d","M7.49991 0.877075C3.84222 0.877075 0.877075 3.84222 0.877075 7.49991C0.877075 11.1576 3.84222 14.1227 7.49991 14.1227C11.1576 14.1227 14.1227 11.1576 14.1227 7.49991C14.1227 3.84222 11.1576 0.877075 7.49991 0.877075ZM3.85768 3.15057C4.84311 2.32448 6.11342 1.82708 7.49991 1.82708C10.6329 1.82708 13.1727 4.36689 13.1727 7.49991C13.1727 8.88638 12.6753 10.1567 11.8492 11.1421L3.85768 3.15057ZM3.15057 3.85768C2.32448 4.84311 1.82708 6.11342 1.82708 7.49991C1.82708 10.6329 4.36689 13.1727 7.49991 13.1727C8.88638 13.1727 10.1567 12.6753 11.1421 11.8492L3.15057 3.85768Z"),i(t,"fill","currentColor"),i(e,"width","15"),i(e,"height","15"),i(e,"viewBox","0 0 15 15"),i(e,"fill","none"),i(e,"xmlns","http://www.w3.org/2000/svg")},m(s,n){I(s,e,n),v(e,t)},p:u,i:u,o:u,d(s){s&&y(e)}}}class Ie extends b{constructor(e){super(),x(this,e,null,oe,R,{})}}export{be as C,ve as D,xe as F,we as M,ye as O,G as R,Ee as S,me as T,Le as U,ue as a,Ae as b,Ce as c,Re as d,Ie as e,X as f,fe as g,pe as h,Se as i,_e as j};
