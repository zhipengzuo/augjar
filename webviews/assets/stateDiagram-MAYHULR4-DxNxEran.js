import{s as O,a as E,b as P}from"./chunk-7U56Z5CX-Bb2_ituO.js";import{_ as f,d as t,j as T,l as S,k as R,e as z,a1 as U,a8 as C,v as I}from"./AugmentMessage-x438MRdb.js";import{G as W}from"./graph-D4UWwI0Q.js";import{l as j}from"./layout-C3Rws-0_.js";import"./chunk-5HRBRIJM-Ds7j3TFX.js";import"./index-p4Dt6o3z.js";import"./github-hmyLGe0b.js";import"./augment-logo-C66YBCMf.js";import"./TextTooltipAugment-C0ygVke5.js";import"./IconButtonAugment-B0XoCIXT.js";import"./ButtonAugment-DueOA3_V.js";import"./Content-7zb4jZEH.js";import"./globals-D0QH3NT1.js";import"./chat-context-Dq8CyOam.js";import"./pen-to-square-DUXCbbi7.js";import"./file-paths-BEF4tZXQ.js";import"./CollapseButtonAugment-C3mt1EeR.js";import"./toggleHighContrast-CKn954qg.js";import"./preload-helper-Dv6uf1Os.js";import"./keypress-DD1aQVr0.js";import"./await_block-CgSfNRTu.js";import"./circle-backslash-B3nG_JMr.js";import"./expand-Ccnb8uFO.js";import"./index-CkBhOCxh.js";import"./ellipsis-Bz-dObmZ.js";import"./IconFilePath-DrTaSdRG.js";import"./LanguageIcon-e6aGriGL.js";import"./next-edit-types-904A5ehg.js";import"./MaterialIcon-9THX1buP.js";import"./mcp-logo-CiDifGtg.js";import"./play-DmB9WugJ.js";import"./_baseUniq-BUzPNbzO.js";import"./_basePickBy-BpDJR12m.js";var w,H={},F=f((e,i)=>{H[e]=i},"set"),J=f(e=>H[e],"get"),G=f(()=>Object.keys(H),"keys"),Y=f(()=>G().length,"size"),$={get:J,set:F,keys:G,size:Y},X=f(e=>e.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),"drawStartState"),_=f(e=>e.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",2*t().state.textHeight).attr("y1",0).attr("y2",0),"drawDivider"),q=f((e,i)=>{const o=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),d=o.node().getBBox();return e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",d.width+2*t().state.padding).attr("height",d.height+2*t().state.padding).attr("rx",t().state.radius),o},"drawSimpleState"),Z=f((e,i)=>{const o=f(function(p,m,b){const B=p.append("tspan").attr("x",2*t().state.padding).text(m);b||B.attr("dy",t().state.textHeight)},"addTspan"),d=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.descriptions[0]).node().getBBox(),n=d.height,h=e.append("text").attr("x",t().state.padding).attr("y",n+.4*t().state.padding+t().state.dividerMargin+t().state.textHeight).attr("class","state-description");let l=!0,a=!0;i.descriptions.forEach(function(p){l||(o(h,p,a),a=!1),l=!1});const s=e.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+n+t().state.dividerMargin/2).attr("y2",t().state.padding+n+t().state.dividerMargin/2).attr("class","descr-divider"),x=h.node().getBBox(),c=Math.max(x.width,d.width);return s.attr("x2",c+3*t().state.padding),e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",c+2*t().state.padding).attr("height",x.height+n+2*t().state.padding).attr("rx",t().state.radius),e},"drawDescrState"),K=f((e,i,o)=>{const d=t().state.padding,n=2*t().state.padding,h=e.node().getBBox(),l=h.width,a=h.x,s=e.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(i.id),x=s.node().getBBox().width+n;let c,p=Math.max(x,l);p===l&&(p+=n);const m=e.node().getBBox();i.doc,c=a-d,x>l&&(c=(l-p)/2+d),Math.abs(a-m.x)<d&&x>l&&(c=a-(x-l)/2);const b=1-t().state.textHeight;return e.insert("rect",":first-child").attr("x",c).attr("y",b).attr("class",o?"alt-composit":"composit").attr("width",p).attr("height",m.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),s.attr("x",c+d),x<=l&&s.attr("x",a+(p-n)/2-x/2+d),e.insert("rect",":first-child").attr("x",c).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",p).attr("height",3*t().state.textHeight).attr("rx",t().state.radius),e.insert("rect",":first-child").attr("x",c).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",p).attr("height",m.height+3+2*t().state.textHeight).attr("rx",t().state.radius),e},"addTitleAndBox"),Q=f(e=>(e.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),e.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),"drawEndState"),V=f((e,i)=>{let o=t().state.forkWidth,d=t().state.forkHeight;if(i.parentId){let n=o;o=d,d=n}return e.append("rect").style("stroke","black").style("fill","black").attr("width",o).attr("height",d).attr("x",t().state.padding).attr("y",t().state.padding)},"drawForkJoinState"),tt=f((e,i,o,d)=>{let n=0;const h=d.append("text");h.style("text-anchor","start"),h.attr("class","noteText");let l=e.replace(/\r\n/g,"<br/>");l=l.replace(/\n/g,"<br/>");const a=l.split(z.lineBreakRegex);let s=1.25*t().state.noteMargin;for(const x of a){const c=x.trim();if(c.length>0){const p=h.append("tspan");p.text(c),s===0&&(s+=p.node().getBBox().height),n+=s,p.attr("x",i+t().state.noteMargin),p.attr("y",o+n+1.25*t().state.noteMargin)}}return{textWidth:h.node().getBBox().width,textHeight:n}},"_drawLongText"),et=f((e,i)=>{i.attr("class","state-note");const o=i.append("rect").attr("x",0).attr("y",t().state.padding),d=i.append("g"),{textWidth:n,textHeight:h}=tt(e,0,0,d);return o.attr("height",h+2*t().state.noteMargin),o.attr("width",n+2*t().state.noteMargin),o},"drawNote"),D=f(function(e,i){const o=i.id,d={id:o,label:i.id,width:0,height:0},n=e.append("g").attr("id",o).attr("class","stateGroup");i.type==="start"&&X(n),i.type==="end"&&Q(n),i.type!=="fork"&&i.type!=="join"||V(n,i),i.type==="note"&&et(i.note.text,n),i.type==="divider"&&_(n),i.type==="default"&&i.descriptions.length===0&&q(n,i),i.type==="default"&&i.descriptions.length>0&&Z(n,i);const h=n.node().getBBox();return d.width=h.width+2*t().state.padding,d.height=h.height+2*t().state.padding,$.set(o,d),d},"drawState"),L=0,at=f(function(e,i,o){const d=f(function(s){switch(s){case E.relationType.AGGREGATION:return"aggregation";case E.relationType.EXTENSION:return"extension";case E.relationType.COMPOSITION:return"composition";case E.relationType.DEPENDENCY:return"dependency"}},"getRelationType");i.points=i.points.filter(s=>!Number.isNaN(s.y));const n=i.points,h=U().x(function(s){return s.x}).y(function(s){return s.y}).curve(C),l=e.append("path").attr("d",h(n)).attr("id","edge"+L).attr("class","transition");let a="";if(t().state.arrowMarkerAbsolute&&(a=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search,a=a.replace(/\(/g,"\\("),a=a.replace(/\)/g,"\\)")),l.attr("marker-end","url("+a+"#"+d(E.relationType.DEPENDENCY)+"End)"),o.title!==void 0){const s=e.append("g").attr("class","stateLabel"),{x,y:c}=I.calcLabelPosition(i.points),p=z.getRows(o.title);let m=0;const b=[];let B=0,M=0;for(let u=0;u<=p.length;u++){const g=s.append("text").attr("text-anchor","middle").text(p[u]).attr("x",x).attr("y",c+m),y=g.node().getBBox();B=Math.max(B,y.width),M=Math.min(M,y.x),S.info(y.x,x,c+m),m===0&&(m=g.node().getBBox().height,S.info("Title height",m,c)),b.push(g)}let N=m*p.length;if(p.length>1){const u=(p.length-1)*m*.5;b.forEach((g,y)=>g.attr("y",c+y*m-u)),N=m*p.length}const r=s.node().getBBox();s.insert("rect",":first-child").attr("class","box").attr("x",x-B/2-t().state.padding/2).attr("y",c-N/2-t().state.padding/2-3.5).attr("width",B+t().state.padding).attr("height",N+t().state.padding),S.info(r)}L++},"drawEdge"),v={},it=f(function(){},"setConf"),rt=f(function(e){e.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers"),nt=f(function(e,i,o,d){w=t().state;const n=t().securityLevel;let h;n==="sandbox"&&(h=T("#i"+i));const l=T(n==="sandbox"?h.nodes()[0].contentDocument.body:"body"),a=n==="sandbox"?h.nodes()[0].contentDocument:document;S.debug("Rendering diagram "+e);const s=l.select(`[id='${i}']`);rt(s);const x=d.db.getRootDoc();A(x,s,void 0,!1,l,a,d);const c=w.padding,p=s.node().getBBox(),m=p.width+2*c,b=p.height+2*c;R(s,b,1.75*m,w.useMaxWidth),s.attr("viewBox",`${p.x-w.padding}  ${p.y-w.padding} `+m+" "+b)},"draw"),dt=f(e=>e?e.length*w.fontSizeFactor:1,"getLabelWidth"),A=f((e,i,o,d,n,h,l)=>{const a=new W({compound:!0,multigraph:!0});let s,x=!0;for(s=0;s<e.length;s++)if(e[s].stmt==="relation"){x=!1;break}o?a.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:x?1:w.edgeLengthFactor,nodeSep:x?1:50,isMultiGraph:!0}):a.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:x?1:w.edgeLengthFactor,nodeSep:x?1:50,ranker:"tight-tree",isMultiGraph:!0}),a.setDefaultEdgeLabel(function(){return{}}),l.db.extract(e);const c=l.db.getStates(),p=l.db.getRelations(),m=Object.keys(c);for(const r of m){const u=c[r];let g;if(o&&(u.parentId=o),u.doc){let y=i.append("g").attr("id",u.id).attr("class","stateGroup");g=A(u.doc,y,u.id,!d,n,h,l);{y=K(y,u,d);let k=y.node().getBBox();g.width=k.width,g.height=k.height+w.padding/2,v[u.id]={y:w.compositTitleSize}}}else g=D(i,u,a);if(u.note){const y={descriptions:[],id:u.id+"-note",note:u.note,type:"note"},k=D(i,y,a);u.note.position==="left of"?(a.setNode(g.id+"-note",k),a.setNode(g.id,g)):(a.setNode(g.id,g),a.setNode(g.id+"-note",k)),a.setParent(g.id,g.id+"-group"),a.setParent(g.id+"-note",g.id+"-group")}else a.setNode(g.id,g)}S.debug("Count=",a.nodeCount(),a);let b=0;p.forEach(function(r){b++,S.debug("Setting edge",r),a.setEdge(r.id1,r.id2,{relation:r,width:dt(r.title),height:w.labelHeight*z.getRows(r.title).length,labelpos:"c"},"id"+b)}),j(a),S.debug("Graph after layout",a.nodes());const B=i.node();a.nodes().forEach(function(r){r!==void 0&&a.node(r)!==void 0?(S.warn("Node "+r+": "+JSON.stringify(a.node(r))),n.select("#"+B.id+" #"+r).attr("transform","translate("+(a.node(r).x-a.node(r).width/2)+","+(a.node(r).y+(v[r]?v[r].y:0)-a.node(r).height/2)+" )"),n.select("#"+B.id+" #"+r).attr("data-x-shift",a.node(r).x-a.node(r).width/2),h.querySelectorAll("#"+B.id+" #"+r+" .divider").forEach(u=>{const g=u.parentElement;let y=0,k=0;g&&(g.parentElement&&(y=g.parentElement.getBBox().width),k=parseInt(g.getAttribute("data-x-shift"),10),Number.isNaN(k)&&(k=0)),u.setAttribute("x1",0-k+8),u.setAttribute("x2",y-k-8)})):S.debug("No Node "+r+": "+JSON.stringify(a.node(r)))});let M=B.getBBox();a.edges().forEach(function(r){r!==void 0&&a.edge(r)!==void 0&&(S.debug("Edge "+r.v+" -> "+r.w+": "+JSON.stringify(a.edge(r))),at(i,a.edge(r),a.edge(r).relation))}),M=B.getBBox();const N={id:o||"root",label:o||"root",width:0,height:0};return N.width=M.width+2*w.padding,N.height=M.height+2*w.padding,S.debug("Doc rendered",N,a),N},"renderDoc"),It={parser:O,db:E,renderer:{setConf:it,draw:nt},styles:P,init:f(e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute,E.clear()},"init")};export{It as diagram};
